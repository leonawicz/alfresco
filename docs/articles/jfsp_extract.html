<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JFSP data extraction • alfresco</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google analytics --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">alfresco</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/alfresco.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/jfsp_extract.html">JFSP data extraction</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-globe fa-lg"></span>
     
    SNAPverse
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://leonawicz.github.io/sv.html">Home of the verse</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Sector packages</li>
    <li>
      <a href="http://leonawicz.github.io/snapverse">snapverse</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snaplite">snaplite</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapdata">snapdata</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapwebs">snapwebs</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Functions packages</li>
    <li>
      <a href="http://leonawicz.github.io/snapfuns">snapfuns</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapprep">snapprep</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/alfresco">alfresco</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Data packages</li>
    <li>
      <a href="http://leonawicz.github.io/snapclim">snapclim</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapfire">snapfire</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snappoly">snappoly</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapgrid">snapmaps</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapdist">snapdist</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Apps &amp; docs packages</li>
    <li>
      <a href="http://leonawicz.github.io/snapapps">snapapps</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapdash">snapdash</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapflex">snapflex</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapdocs">snapdocs</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Satellite packages</li>
    <li>
      <a href="http://leonawicz.github.io/rvtable">rvtable</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/apputils">apputils</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/maputils">maputils</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snaputils">snaputils</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapmeta">snapmeta</a>
    </li>
    <li>
      <a href="http://leonawicz.github.io/snapsite">snapsite</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/leonawicz/alfresco">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>JFSP data extraction</h1>
            
          </div>

    
    
<div class="contents">
<div id="preparing-files" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-files" class="anchor"></a>Preparing files</h2>
<p>Not all files output by ALFRESCO are necessary. Since there are so many, it is helpful to make an isolated, smaller copy of only the subset of required files. This also creates an opportunity to reorganize their structure in a way that is more useful and can bew made consistent across different ALFRESCO projects.</p>
<p>Create a bash script from R on Atlas. Note the working directory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(alfresco)
<span class="kw"><a href="../reference/copy_alf_outputs.html">copy_alf_outputs</a></span>(<span class="st">"JFSP"</span>, <span class="st">"/big_scratch/shiny/Runs_Statewide/paul.duffy</span><span class="ch">\\</span><span class="st">@neptuneinc.org"</span>, 
    <span class="dt">domain =</span> <span class="st">"ak1km"</span>)</code></pre></div>
<p>Then exit R. From the command line, run the bash script for each model run, e.g.:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">bash</span> copy_alf_outputs.sh historical CRU32 historical fmo00s00i</code></pre></div>
<p>See the documentation for <code>copy_alf_outputs</code> for details on command line arguments.</p>
</div>
<div id="generate-slurm-and-r-scripts" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-slurm-and-r-scripts" class="anchor"></a>Generate slurm and R scripts</h2>
<p>To perform effecient data extraction on ALFRESCO output maps for the JFSP project, the first step is to create a slurm script to be executed by the SLURM job manager on SNAP’s Atlas cluster. This script will run an accompanying R script that performs the extraction on the geotiffs output by ALFRESCO. To generate these two files, do the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/alf_extract_slurm.html">alf_extract_slurm</a></span>(<span class="dt">domain =</span> <span class="st">"ak1km"</span>, <span class="dt">project =</span> <span class="st">"JFSP"</span>, <span class="dt">years =</span> <span class="dv">1950</span>:<span class="dv">2013</span>, <span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">30</span>, 
    <span class="dt">cru =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/bash</span>
<span class="co">#SBATCH --exclusive</span>
<span class="co">#SBATCH --mail-type=END</span>
<span class="co">#SBATCH --mail-user=mfleonawicz@alaska.edu</span>
<span class="co">#SBATCH --account=snap</span>
<span class="co">#SBATCH -p main</span>
<span class="co">#SBATCH --ntasks=64 # one for each year</span>
<span class="co">#SBATCH --job-name=alf_extract</span>
<span class="co">#SBATCH --nodes=2</span>
<span class="co">#SBATCH --ntasks-per-node=32</span>

<span class="kw">mpirun</span> --oversubscribe -np 1 Rscript ./alf_extract.R domain=<span class="dt">\'</span>ak1km<span class="dt">\'</span> rmpi=TRUE project=<span class="dt">\'</span>JFSP<span class="dt">\'</span> years=1950:2013 reps=1:32 cru=TRUE <span class="ot">$1</span> <span class="ot">$2</span> <span class="ot">$3</span></code></pre></div>
<p>This creates a slurm script with some hardcoded arguments that are passed on to the R script. This is convenient because the slurm script will be run several times for each combination of climate models and emissions scenarios (GCMs and RCPs) and it is nice to not have to repeatedly specify several other command line arguments that do not change from set of ALFRESCO outputs to the next.</p>
<p>The data extraction procedure makes use of the <code>Rmpi</code> package with a master R process running on the Atlas head node and 64 slave processes (one for each year) running on 32 CPUs across two different compute nodes.</p>
<p>This function also creates a template R script for standard extractions show below. It reveals that <code>Rmpi</code> is not a requirement. Alternatively, we can run the same R script on a single compute node, parallelizing over multiple CPUs with the base R <code>parallel</code> package. However, using <code>Rmpi</code> on the Atlas cluster offers much greater access to total CPUs and RAM by coordinating the extractions across multiple compute nodes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgdal)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(alfresco)
cargs &lt;-<span class="st"> </span>(<span class="kw">commandArgs</span>(<span class="ot">TRUE</span>))
if (!<span class="kw">length</span>(cargs)) <span class="kw">q</span>(<span class="st">"no"</span>) else for (i in <span class="dv">1</span>:<span class="kw">length</span>(cargs)) <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> cargs[[i]]))
<span class="kw"><a href="../reference/extract_alf_stops.html">extract_alf_stops</a></span>()

if (!<span class="kw">exists</span>(<span class="st">"rmpi"</span>)) rmpi &lt;-<span class="st"> </span><span class="ot">TRUE</span>
if (<span class="kw">exists</span>(<span class="st">"repSample"</span>) &amp;&amp;<span class="st"> </span><span class="kw">is.numeric</span>(repSample)) {
    <span class="kw">set.seed</span>(<span class="dv">47</span>)
    reps &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">sample</span>(reps, <span class="kw">min</span>(repSample, <span class="kw">length</span>(reps))))
    <span class="kw">cat</span>(<span class="st">"Sampled replicates:</span><span class="ch">\n</span><span class="st">"</span>, reps, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
}
if (!<span class="kw">exists</span>(<span class="st">"cru"</span>)) cru &lt;-<span class="st"> </span><span class="ot">FALSE</span>

if (rmpi) {
    <span class="kw">library</span>(Rmpi)
    <span class="kw">mpi.spawn.Rslaves</span>(<span class="dt">needlog =</span> <span class="ot">TRUE</span>)
    <span class="kw">mpi.bcast.cmd</span>(rmpi_proc_id &lt;-<span class="st"> </span><span class="kw">mpi.comm.rank</span>())
    <span class="kw">mpi.bcast.cmd</span>(np &lt;-<span class="st"> </span><span class="kw">mpi.comm.size</span>())
    <span class="kw">mpi.bcast.cmd</span>(host &lt;-<span class="st"> </span><span class="kw">mpi.get.processor.name</span>())
} else {
    <span class="kw">library</span>(parallel)
    n.cores &lt;-<span class="st"> </span><span class="dv">32</span>
}
cells &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_domain_cells.html">get_domain_cells</a></span>(domain)
veg_labels &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_veg_labels.html">get_veg_labels</a></span>(domain)
dirs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_out_dirs.html">get_out_dirs</a></span>(domain, project, cru)
main_dirs &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">paste0</span>(dirs, <span class="st">"/Maps"</span>)[modelIndex], <span class="dt">each =</span> <span class="kw">length</span>(years))
main_dir &lt;-<span class="st"> </span>main_dirs[<span class="dv">1</span>]  <span class="co"># all equal when single modelIndex</span>

<span class="co"># Export objects to slaves</span>
if (rmpi) {
    <span class="kw">mpi.bcast.Robj2slave</span>(cells)
    <span class="kw">mpi.bcast.Robj2slave</span>(reps)
    <span class="kw">mpi.bcast.Robj2slave</span>(years)
    <span class="kw">mpi.bcast.Robj2slave</span>(main_dirs)
    <span class="kw">mpi.bcast.Robj2slave</span>(veg_labels)
    <span class="kw">print</span>(<span class="st">"mpi.bcast.Robj2slave calls completed."</span>)
}

<span class="co"># Issue commands to slaves</span>
if (rmpi) {
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">library</span>(rgdal))
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">library</span>(raster))
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">library</span>(alfresco))
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">dir.create</span>(tmp_dir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw"><a href="../reference/alfdef.html">alfdef</a></span>()$raster_tmp_dir, <span class="st">"/proc"</span>, 
        rmpi_proc_id), <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>))
    <span class="kw">mpi.bcast.cmd</span>(<span class="kw">rasterOptions</span>(<span class="dt">chunksize =</span> <span class="fl">1e+11</span>, <span class="dt">maxmemory =</span> <span class="fl">1e+12</span>, <span class="dt">tmpdir =</span> tmp_dir))
    <span class="kw">print</span>(<span class="st">"mpi.bcast.cmd calls completed. Now running mpi.remote.exec..."</span>)
} else {
    tmp_dir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw"><a href="../reference/alfdef.html">alfdef</a></span>()$raster_tmp_dir, <span class="st">"procX"</span>)
    <span class="kw">rasterOptions</span>(<span class="dt">chunksize =</span> <span class="fl">1e+11</span>, <span class="dt">maxmemory =</span> <span class="fl">1e+12</span>, <span class="dt">tmpdir =</span> tmp_dir)
}

<span class="kw"><a href="../reference/run_alf_extraction.html">run_alf_extraction</a></span>(domain, <span class="dt">type =</span> <span class="st">"fsv"</span>, <span class="dt">main_dir =</span> main_dir, <span class="dt">project =</span> project, 
    <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, <span class="dt">cells =</span> cells, <span class="dt">veg_labels =</span> veg_labels, <span class="dt">cru =</span> cru, 
    <span class="dt">rmpi =</span> rmpi)
<span class="kw"><a href="../reference/run_alf_extraction.html">run_alf_extraction</a></span>(domain, <span class="dt">type =</span> <span class="st">"av"</span>, <span class="dt">main_dir =</span> main_dir, <span class="dt">project =</span> project, 
    <span class="dt">reps =</span> reps, <span class="dt">years =</span> years, <span class="dt">cells =</span> cells, <span class="dt">veg_labels =</span> veg_labels, <span class="dt">cru =</span> cru, 
    <span class="dt">rmpi =</span> rmpi)

if (rmpi) {
    <span class="kw">mpi.close.Rslaves</span>(<span class="dt">dellog =</span> <span class="ot">FALSE</span>)
    <span class="kw">mpi.exit</span>()
}</code></pre></div>
<p>Note that the <code>alfresco</code> package assumes sensible defaults for file paths and organization based on the Atlas file system. Unless specifying a custom location with <code>out_dir</code>, the generated scripts will be placed in an Atlas directory based on file paths stored in <code><a href="http://www.rdocumentation.org/packages/alfresco/topics/alfdef">alfresco::alfdef()</a></code>. See the documentation for <code>alf_extract_slurm</code> for usage details.</p>
</div>
<div id="initial-geotiff-data-extraction" class="section level2">
<h2 class="hasAnchor">
<a href="#initial-geotiff-data-extraction" class="anchor"></a>Initial geotiff data extraction</h2>
<p>The next step is to begin data extraction from the raster layer data output by ALFRESCO in geotiff files. To do this, execute the slurm script at the Atlas command line, making sure to supply any required arguments that were not written directly into the slurm script when it was previously generated. Assuming we are in the directory where the slurm and R script live and created them as shown above,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/alfdef.html">alfdef</a></span>()$alf_slurm_dir
<span class="co">#&gt; [1] "/atlas_scratch/mfleonawicz/alfresco/slurm_jobs"</span></code></pre></div>
<p>we simply calls <code>sbatch</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sbatch</span> alf_extract.slurm modelIndex=1</code></pre></div>
<p>The <code>modelIndex</code> refers to the position in the list of climate model (or climate model/RCP group) directories pertaining to the given ALFRESCO project. For example, if an ALFRESCO project uses five GCMs and 3 RCPs, there are 15 directories of ALFRESCO outputs under the project directory. Each of these contains GCM/RCP-specific run outputs in a <code>Maps</code> subdirectory. The <code>sbatch</code> call is made for each of these 15 sets of GCM/RCP outputs.</p>
<p>In this example, we are working with only historical run output over 16 combinations of fire management options as part of an experimental design. WE conveniently built into the slurm script all the arguments that are constant across these 16 treatments, such as the project name, the spatial domain of the ALFRESCO runs, the fact that the runs are based on CRU historical climate data rather than projected GCM outputs, the set of years and the set of simulation replicates. This makes the <code>sbatch</code> call short, having only to iterate over <code>modelIndex</code> for all 16 ALFRESCO runs without specifying the rest. For a different ALFRESCO project, we would generate a different slurm script. The template R script run by the slurm script is the same in every case. What is variable is how general or specific the slurm script is, which depends on what is explicitly specified in <code>alf_extract_slurm</code>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#preparing-files">Preparing files</a></li>
      <li><a href="#generate-slurm-and-r-scripts">Generate slurm and R scripts</a></li>
      <li><a href="#initial-geotiff-data-extraction">Initial geotiff data extraction</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://leonawicz.github.io/">Matthew Leonawicz</a>, <a href="http://snap.uaf.edu/"><img src="https://raw.githubusercontent.com/leonawicz/leonawicz.github.io/master/assets/img/snap_symbol.svg?sanitize=true" height="24">  Scenarios Network for Alaska and Arctic Planning</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
